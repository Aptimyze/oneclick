.row
  .col-sm-7
    .hidden-xs.col-sm-8
      = render partial: 'shared/trip_plan_breadcrumbs'
    .col-sm-4{style: "padding: 0px;"}
      = button_tag :type => 'submit', :name => 'planTrip', :class => "btn btn-default pull-right action-button" do
        =t(:next)
        :javascript
          $(function() {
            $('button[name=planTrip]').click(function() {
              $('.plan-a-trip').submit();
            });
          });
.row
  .col-sm-7.col-xs-12
    = simple_form_for @trip_proxy, :url => @trip_proxy.id.nil? ? user_trips_path(locale: I18n.locale) : user_trip_path(locale: I18n.locale), :method => @trip_proxy.id.nil? ? 'post' : 'put', :html => {:class => "plan-a-trip form-horizontal no-bottom-margin", :style => "margin-top:10px;margin-bottom:0px;"}, wrapper: :horizontal_form, wrapper_mappings: {check_boxes: :horizontal_radio_and_checkboxes, radio_buttons: :plan_trip_radio}  do |f|
      .col-xs-12.panel.panel-default
        .panel-body
          = f.hidden_field :mode
          = f.hidden_field :from_place_object, :id => "from_place_object"
          = f.hidden_field :to_place_object, :id => "to_place_object"
          = f.hidden_field :map_center, id: "map_center"

          #tripOptions
            = field_set_tag do
              %legend.sr-only Trip type
              .inline-radio
                = f.input :is_round_trip, as: :radio_buttons, label: t(:trip), collection: [[t(:round_trip), 1], [t(:one_way), 0]],
                  checked: (@trip_proxy.is_round_trip ? "1" : "0")

              :javascript
                $('#tripOptions :radio').change(function() {
                  if(this.value === '0') {
                    $('#returnDatetimeOptions').hide();
                  } else {
                    $('#returnDatetimeOptions').show();
                  }
                });

          = field_set_tag do
            %legend.sr-only Modes
            #baseModes
              = f.input :modes, as: :check_boxes, collection: @modes,
              label_method: :first, value_method: :last, checked: @selected_modes, label: t(:modes)

            :javascript
              $('#trip_proxy_modes_mode_transit').change(function() {
                if(this.checked) {
                  $('#transitModes input[type="checkbox"]').each(function() {
                      this.checked = true;
                  });
                } else {
                  $('#transitModes input[type="checkbox"]').each(function() {
                      this.checked = false;
                  });
                }
              });

          #transitModes
            = f.input :modes, as: :check_boxes, collection: @transit_modes,
            label_method: :first, value_method: :last, checked: @selected_modes, label: '',
            collection_wrapper_class: 'col-xs-offset-1', collection_wrapper_tag: :div

            :javascript
              $('#transitModes input[type="checkbox"]').change( function() {
                var checkedCount = $('#transitModes input:checked').length;
                if (checkedCount === 0) {
                  $("#trip_proxy_modes_mode_transit").prop('checked', false);
                } else {
                  $("#trip_proxy_modes_mode_transit").prop('checked', true);
                }
              });


          = f.input :trip_purpose_id, :collection =>  TripPurpose.ordered_by_localized_name, :selected => @trip_proxy.trip_purpose_id, :value => :id, :label_method => lambda { |v| t(v.name)}, label: t(:trip_purposes),
          input_html: { class: 'form-control' }

          = render partial: 'location_input', locals: {dir: 'from', f: f}
          = render partial: 'location_input', locals: {dir: 'to', f: f}

          .form-group
            = render partial: 'date_time_input', locals: {dir: 'outbound', f: f}

          #returnDatetimeOptions{style: (@trip_proxy.is_round_trip ? '' : 'display: none;')}
            .form-group
              = render partial: 'date_time_input', locals: {dir: 'return', f: f}
          .hidden-xs.hidden-sm{id: "tripMapContainer", 'aria-hidden' => 'true', class: 'hide', style: 'position: absolute; top: 0; right:-520px; z-index: 1000;'}
            .panel.panel-default
              .panel-heading.clearfix
                %button#mapCloseButton.close.pull-right{type: "button", title: t(:close)}
                  %span{:"aria-hidden" => "true"} &times;
                  %span.hide Close
              .panel-body
                = LeafletMap({ :mapid => "tripMap", :markers => @markers, :tile_provider => 'GOOGLEMAP', :min_zoom => 3, :max_zoom => 15, :class => "map", width: '500px;', :style => "height: 400px; width: 500px;", :show_location_select => true })
    .col-xs-12{style: "margin-bottom: 5px; padding: 0px;"}
      = button_tag :type => 'submit', :name => 'planTrip', :class => "btn btn-default pull-right action-button" do
        =t(:next)
  = render partial: 'shared/splash'
  -if @show_booking
    = render partial: 'booking_signup'
:javascript
  $(function() {
    $('.plan-a-trip').on('submit',function() {
      var hiddenFromPlaceData = $('#from_place_object').val();
      var fromPlaceAddr = $('#trip_proxy_from_place').val();
      var isResetHiddenFromPlace = true;
      try {
        var hiddenFromPlaceJson = JSON.parse(hiddenFromPlaceData);
        if(hiddenFromPlaceJson.address === fromPlaceAddr || hiddenFromPlaceJson.name === fromPlaceAddr) {
          isResetHiddenFromPlace = false;
        }
      }
      catch(e) {
        //hiddenFromPlaceData non-parsable to json
      }
      if(isResetHiddenFromPlace) {
        $('#from_place_object').val('');
      }

      var hiddenToPlaceData = $('#to_place_object').val();
      var toPlaceAddr = $('#trip_proxy_to_place').val();
      var isResetHiddenToPlace = true;
      try {
        var hiddenToPlaceJson = JSON.parse(hiddenToPlaceData);
        if(hiddenToPlaceJson.address === toPlaceAddr || hiddenToPlaceJson.name === toPlaceAddr) {
          isResetHiddenToPlace = false;
        }
      }
      catch(e) {
        //hiddenToPlaceData non-parsable to json
      }
      if(isResetHiddenToPlace) {
        $('#to_place_object').val('');
      }

      return true;
    });
  });
